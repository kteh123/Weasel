<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>Weasel.Pipelines.XNAT__App API documentation</title>
<meta name="description" content="Prompts an Input Window where the user can insert their XNAT portal credentials and download or upload the selected DICOM images." />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>Weasel.Pipelines.XNAT__App</code></h1>
</header>
<section id="section-intro">
<p>Prompts an Input Window where the user can insert their XNAT portal credentials and download or upload the selected DICOM images.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
Prompts an Input Window where the user can insert their XNAT portal credentials and download or upload the selected DICOM images.
&#34;&#34;&#34;

import os
import datetime
import zipfile
import warnings
import requests
import xnat

def isEnabled(self):
    return True

def download(weasel):
    try:
        url_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;URL&#34;, &#34;value&#34;:&#34;https://test-ukrin.dpuk.org&#34;}
        username_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;Username&#34;, &#34;value&#34;:&#34;your.xnat.username&#34;}
        password_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;Password&#34;}
        cancel, loginDetails = weasel.user_input(url_input, username_input, password_input, title=&#34;XNAT Login&#34;)
        if cancel: return
        url = loginDetails[0][&#39;value&#39;] # https://test-ukrin.dpuk.org
        username = loginDetails[1][&#39;value&#39;]
        password = loginDetails[2][&#39;value&#39;]
        with xnat.connect(url, user=username, password=password) as session:
            xnatProjects = [project.secondary_id for project in session.projects.values()]
            projectWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Project&#34;, &#34;list&#34;:xnatProjects}
            cancel, project = weasel.user_input(projectWindow, title=&#34;XNAT Download&#34;)
            if cancel: return
            projectID = project[0][&#39;list&#39;][project[0][&#39;value&#39;]]
            projectName = [project.name for project in session.projects.values() if project.secondary_id == projectID][0]
            if projectName:
                xnatSubjects = [subject.label for subject in session.projects[projectName].subjects.values()]
                xnatSubjects.insert(0, &#34;All&#34;)
                subjectWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Subject&#34;, &#34;list&#34;:xnatSubjects}
                cancel, subject = weasel.user_input(subjectWindow, title=&#34;XNAT Download&#34;)
                if cancel: return
                subjectName = subject[0][&#39;list&#39;][subject[0][&#39;value&#39;]]
                if subjectName:
                    if subjectName == &#34;All&#34;:
                        dataset = session.projects[projectName]
                        downloadFolder = selectXNATPathDownload(weasel)
                        weasel.information(&#34;The selected images will be downloaded to the root folder of the TreeView. The download progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Download&#34;)
                        dataset.download_dir(downloadFolder)
                        weasel.information(&#34;Download completed!&#34;, &#34;XNAT Download&#34;)
                    else:
                        xnatExperiments = [experiment.label for experiment in session.projects[projectName].subjects[subjectName].experiments.values()]
                        xnatExperiments.insert(0, &#34;All&#34;)
                        experimentWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Experiment&#34;, &#34;list&#34;:xnatExperiments}
                        cancel, experiment = weasel.user_input(experimentWindow, title=&#34;XNAT Download&#34;)
                        if cancel: return
                        experimentName = experiment[0][&#39;list&#39;][experiment[0][&#39;value&#39;]]
                        if experimentName:
                            if experimentName == &#34;All&#34;:
                                dataset = session.projects[projectName].subjects[subjectName]
                                downloadFolder = selectXNATPathDownload(weasel)
                                weasel.information(&#34;The selected images will be downloaded to the root folder of the TreeView. The download progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Download&#34;)
                                dataset.download_dir(downloadFolder)
                                weasel.information(&#34;Download completed!&#34;, &#34;XNAT Download&#34;)
                            else:
                                xnatScans = [scan.series_description for scan in session.projects[projectName].subjects[subjectName].experiments[experimentName].scans.values()]
                                xnatScans.insert(0, &#34;All&#34;)
                                scanWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Scan&#34;, &#34;list&#34;:xnatScans}
                                cancel, scan = weasel.user_input(scanWindow, title=&#34;XNAT Download&#34;)
                                if cancel: return
                                scanName = scan[0][&#39;list&#39;][scan[0][&#39;value&#39;]]
                                if scanName:
                                    if scanName == &#34;All&#34;:
                                        dataset = session.projects[projectName].subjects[subjectName].experiments[experimentName]
                                        downloadFolder = selectXNATPathDownload(weasel)
                                        weasel.information(&#34;The selected images will be downloaded to the root folder of the TreeView. The download progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Download&#34;)
                                        dataset.download_dir(downloadFolder)
                                        weasel.information(&#34;Download completed!&#34;, &#34;XNAT Download&#34;)
                                    else:
                                        dataset = session.projects[projectName].subjects[subjectName].experiments[experimentName].scans[scanName]
                                        downloadFolder = selectXNATPathDownload(weasel)
                                        weasel.information(&#34;The selected images will be downloaded to the root folder of the TreeView. The download progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Download&#34;) 
                                        dataset.download_dir(downloadFolder)
                                        weasel.information(&#34;Download completed!&#34;, &#34;XNAT Download&#34;)
            # Load the directory again
            # This loads the whole directory again, so it might take some time. It would be quicker if there was an incremental approach to the TreeView (.xml or .csv).
            weasel.read_dicom_folder()
        # Delete Login Details
        del loginDetails, url, username, password
        session.disconnect()
        return

    except Exception as e:
        weasel.log_error(&#39;Error in function XNATapp.download: &#39; + str(e))
        if &#34;Could not determine if login was successful!&#34; in str(e):
            weasel.information(&#34;The login details inserted are incorrect!&#34;, &#34;XNAT Download&#34;) 


def upload(weasel):
    try:
        url_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;URL&#34;, &#34;value&#34;:&#34;https://test-ukrin.dpuk.org&#34;}
        username_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;Username&#34;, &#34;value&#34;:&#34;your.xnat.username&#34;}
        password_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;Password&#34;}
        cancel, loginDetails = weasel.user_input(url_input, username_input, password_input, title=&#34;XNAT Login&#34;)
        if cancel: return
        url = loginDetails[0][&#39;value&#39;] # https://test-ukrin.dpuk.org
        username = loginDetails[1][&#39;value&#39;]
        password = loginDetails[2][&#39;value&#39;]
        with xnat.connect(url, user=username, password=password) as session:
            xnatProjects = [project.secondary_id for project in session.projects.values()]
            projectWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Project&#34;, &#34;list&#34;:xnatProjects}
            cancel, project = weasel.user_input(projectWindow, title=&#34;XNAT Upload&#34;)
            if cancel: return
            projectID = project[0][&#39;list&#39;][project[0][&#39;value&#39;]]
            projectName = [project.name for project in session.projects.values() if project.secondary_id == projectID][0]
            if projectName:
                xnatSubjects = [subject.label for subject in session.projects[projectName].subjects.values()]
                xnatSubjects.insert(0, &#34;Upload at Project Level&#34;)
                subjectWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Subject&#34;, &#34;list&#34;:xnatSubjects}
                cancel, subject = weasel.user_input(subjectWindow, title=&#34;XNAT Upload&#34;)
                if cancel: return
                subjectName = subject[0][&#39;list&#39;][subject[0][&#39;value&#39;]]
                if subjectName:
                    if subjectName == &#34;Upload at Project Level&#34;:
                        uploadPaths = selectXNATPathUpload(weasel)
                        uploadZipFile = zipFiles(uploadPaths)
                        weasel.information(&#34;The selected images will be uploaded to the selected project. The upload progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Upload&#34;)
                        try:
                            weasel.message(&#34;Uploading files to XNAT...&#34;, &#34;XNAT Upload&#34;)
                            session.services.import_(uploadZipFile, overwrite=&#39;none&#39;, project=session.projects[projectName].id, content_type=&#39;application/zip&#39;)
                            weasel.close_message()
                        except:
                            warnings.warn(&#39;The zip file being uploaded contains files already present in the selected image session and the upload assistant cannot overwrite or give the option to not overwrite. \n The selected file or folder was pre-archived in the selected XNAT project. \n Please login to the portal and review and/or archive the images.&#39;)
                        weasel.information(&#34;Upload completed!&#34;, &#34;XNAT Upload&#34;)
                    else:
                        xnatExperiments = [experiment.label for experiment in session.projects[projectName].subjects[subjectName].experiments.values()]
                        xnatExperiments.insert(0, &#34;Upload at Subject Level&#34;)
                        experimentWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Experiment&#34;, &#34;list&#34;:xnatExperiments}
                        cancel, experiment = weasel.user_input(experimentWindow, title=&#34;XNAT Upload&#34;)
                        if cancel: return
                        experimentName = experiment[0][&#39;list&#39;][experiment[0][&#39;value&#39;]]
                        if experimentName:
                            if experimentName == &#34;Upload at Subject Level&#34;:
                                uploadPaths = selectXNATPathUpload(weasel)
                                uploadZipFile = zipFiles(uploadPaths)
                                weasel.information(&#34;The selected images will be uploaded to the selected subject. The upload progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Upload&#34;)
                                try:
                                    weasel.message(&#34;Uploading files to XNAT...&#34;, &#34;XNAT Upload&#34;)
                                    session.services.import_(uploadZipFile, overwrite=&#39;none&#39;, project=session.projects[projectName].id, subject=session.projects[projectName].subjects[subjectName].id, content_type=&#39;application/zip&#39;)
                                    weasel.close_message()
                                except:
                                    warnings.warn(&#39;The zip file being uploaded contains files already present in the selected image session and the upload assistant cannot overwrite or give the option to not overwrite. \n The selected file or folder was pre-archived in the selected XNAT project. \n Please login to the portal and review and/or archive the images.&#39;)
                                weasel.information(&#34;Upload completed!&#34;, &#34;XNAT Upload&#34;)
                            else:
                                uploadPaths = selectXNATPathUpload(weasel)
                                uploadZipFile = zipFiles(uploadPaths)
                                weasel.information(&#34;The selected images will be uploaded to the selected experiment. The upload progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Upload&#34;)
                                try:
                                    weasel.message(&#34;Uploading files to XNAT...&#34;, &#34;XNAT Upload&#34;)
                                    session.services.import_(uploadZipFile, overwrite=&#39;none&#39;, project=session.projects[projectName].id, subject=session.projects[projectName].subjects[subjectName].id, experiment=session.projects[projectName].subjects[subjectName].experiments[experimentName].id, content_type=&#39;application/zip&#39;)
                                    weasel.close_message()
                                except:
                                    warnings.warn(&#39;The zip file being uploaded contains files already present in the selected image session and the upload assistant cannot overwrite or give the option to not overwrite. \n The selected file or folder was pre-archived in the selected XNAT project. \n Please login to the portal and review and/or archive the images.&#39;)
                                weasel.information(&#34;Upload completed!&#34;, &#34;XNAT Upload&#34;)
        # Curl Command
        headers = {&#34;Content-Type&#34;: &#34;application/json&#34;, &#34;Accept&#34;: &#34;*/*&#34;}
        # Update the project&#39;s indices
        for individual_experiment in session.projects[projectName].experiments:
            curl_url = url + &#34;/xapi/viewer/projects/&#34; + session.projects[projectName].id + &#34;/experiments/&#34; + individual_experiment
            response = requests.post(curl_url, headers=headers, auth=(username, password))
        # Delete Login Details
        del loginDetails, url, username, password
        # Delete ZIP File
        os.remove(uploadZipFile)
        session.disconnect()
    except Exception as e:
        weasel.log_error(&#39;Error in function XNATapp.upload: &#39; + str(e))
        if &#34;Could not determine if login was successful!&#34; in str(e):
            weasel.information(&#34;The login details inserted are incorrect!&#34;, &#34;XNAT Download&#34;) 

    
def selectXNATPathDownload(weasel, tree_view_dir=True):
    if tree_view_dir == False:
        directory = weasel.selectFolder(title=&#34;Select the directory where you wish to download&#34;)
    else:
        directory = os.path.dirname(weasel.objXMLReader.file)
    return directory


def selectXNATPathUpload(weasel, tree_view=True):
    listPaths = []
    if tree_view == True:
        images = weasel.images()
        for image in images:
            listPaths.append(image.path)
    else:
        directory = weasel.selectFolder(title=&#34;Select the directory with the files you wish to upload&#34;)
        for root, _, files in os.walk(directory):
            for filename in files:
                filepath = os.path.join(root, filename)
                listPaths.append(filepath)
    return listPaths


def zipFiles(listPaths):
    dt = datetime.datetime.now()
    zip_file = zipfile.ZipFile(dt.strftime(&#39;%Y%m%d&#39;) + &#39;_xnat_upload.zip&#39;, &#39;w&#39;)
    for file in listPaths:
        zip_file.write(file, compress_type=zipfile.ZIP_DEFLATED)
    zip_file.close()
    zip_path = os.path.realpath(zip_file.filename)
    return zip_path</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="Weasel.Pipelines.XNAT__App.download"><code class="name flex">
<span>def <span class="ident">download</span></span>(<span>weasel)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def download(weasel):
    try:
        url_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;URL&#34;, &#34;value&#34;:&#34;https://test-ukrin.dpuk.org&#34;}
        username_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;Username&#34;, &#34;value&#34;:&#34;your.xnat.username&#34;}
        password_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;Password&#34;}
        cancel, loginDetails = weasel.user_input(url_input, username_input, password_input, title=&#34;XNAT Login&#34;)
        if cancel: return
        url = loginDetails[0][&#39;value&#39;] # https://test-ukrin.dpuk.org
        username = loginDetails[1][&#39;value&#39;]
        password = loginDetails[2][&#39;value&#39;]
        with xnat.connect(url, user=username, password=password) as session:
            xnatProjects = [project.secondary_id for project in session.projects.values()]
            projectWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Project&#34;, &#34;list&#34;:xnatProjects}
            cancel, project = weasel.user_input(projectWindow, title=&#34;XNAT Download&#34;)
            if cancel: return
            projectID = project[0][&#39;list&#39;][project[0][&#39;value&#39;]]
            projectName = [project.name for project in session.projects.values() if project.secondary_id == projectID][0]
            if projectName:
                xnatSubjects = [subject.label for subject in session.projects[projectName].subjects.values()]
                xnatSubjects.insert(0, &#34;All&#34;)
                subjectWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Subject&#34;, &#34;list&#34;:xnatSubjects}
                cancel, subject = weasel.user_input(subjectWindow, title=&#34;XNAT Download&#34;)
                if cancel: return
                subjectName = subject[0][&#39;list&#39;][subject[0][&#39;value&#39;]]
                if subjectName:
                    if subjectName == &#34;All&#34;:
                        dataset = session.projects[projectName]
                        downloadFolder = selectXNATPathDownload(weasel)
                        weasel.information(&#34;The selected images will be downloaded to the root folder of the TreeView. The download progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Download&#34;)
                        dataset.download_dir(downloadFolder)
                        weasel.information(&#34;Download completed!&#34;, &#34;XNAT Download&#34;)
                    else:
                        xnatExperiments = [experiment.label for experiment in session.projects[projectName].subjects[subjectName].experiments.values()]
                        xnatExperiments.insert(0, &#34;All&#34;)
                        experimentWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Experiment&#34;, &#34;list&#34;:xnatExperiments}
                        cancel, experiment = weasel.user_input(experimentWindow, title=&#34;XNAT Download&#34;)
                        if cancel: return
                        experimentName = experiment[0][&#39;list&#39;][experiment[0][&#39;value&#39;]]
                        if experimentName:
                            if experimentName == &#34;All&#34;:
                                dataset = session.projects[projectName].subjects[subjectName]
                                downloadFolder = selectXNATPathDownload(weasel)
                                weasel.information(&#34;The selected images will be downloaded to the root folder of the TreeView. The download progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Download&#34;)
                                dataset.download_dir(downloadFolder)
                                weasel.information(&#34;Download completed!&#34;, &#34;XNAT Download&#34;)
                            else:
                                xnatScans = [scan.series_description for scan in session.projects[projectName].subjects[subjectName].experiments[experimentName].scans.values()]
                                xnatScans.insert(0, &#34;All&#34;)
                                scanWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Scan&#34;, &#34;list&#34;:xnatScans}
                                cancel, scan = weasel.user_input(scanWindow, title=&#34;XNAT Download&#34;)
                                if cancel: return
                                scanName = scan[0][&#39;list&#39;][scan[0][&#39;value&#39;]]
                                if scanName:
                                    if scanName == &#34;All&#34;:
                                        dataset = session.projects[projectName].subjects[subjectName].experiments[experimentName]
                                        downloadFolder = selectXNATPathDownload(weasel)
                                        weasel.information(&#34;The selected images will be downloaded to the root folder of the TreeView. The download progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Download&#34;)
                                        dataset.download_dir(downloadFolder)
                                        weasel.information(&#34;Download completed!&#34;, &#34;XNAT Download&#34;)
                                    else:
                                        dataset = session.projects[projectName].subjects[subjectName].experiments[experimentName].scans[scanName]
                                        downloadFolder = selectXNATPathDownload(weasel)
                                        weasel.information(&#34;The selected images will be downloaded to the root folder of the TreeView. The download progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Download&#34;) 
                                        dataset.download_dir(downloadFolder)
                                        weasel.information(&#34;Download completed!&#34;, &#34;XNAT Download&#34;)
            # Load the directory again
            # This loads the whole directory again, so it might take some time. It would be quicker if there was an incremental approach to the TreeView (.xml or .csv).
            weasel.read_dicom_folder()
        # Delete Login Details
        del loginDetails, url, username, password
        session.disconnect()
        return

    except Exception as e:
        weasel.log_error(&#39;Error in function XNATapp.download: &#39; + str(e))
        if &#34;Could not determine if login was successful!&#34; in str(e):
            weasel.information(&#34;The login details inserted are incorrect!&#34;, &#34;XNAT Download&#34;) </code></pre>
</details>
</dd>
<dt id="Weasel.Pipelines.XNAT__App.isEnabled"><code class="name flex">
<span>def <span class="ident">isEnabled</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def isEnabled(self):
    return True</code></pre>
</details>
</dd>
<dt id="Weasel.Pipelines.XNAT__App.selectXNATPathDownload"><code class="name flex">
<span>def <span class="ident">selectXNATPathDownload</span></span>(<span>weasel, tree_view_dir=True)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def selectXNATPathDownload(weasel, tree_view_dir=True):
    if tree_view_dir == False:
        directory = weasel.selectFolder(title=&#34;Select the directory where you wish to download&#34;)
    else:
        directory = os.path.dirname(weasel.objXMLReader.file)
    return directory</code></pre>
</details>
</dd>
<dt id="Weasel.Pipelines.XNAT__App.selectXNATPathUpload"><code class="name flex">
<span>def <span class="ident">selectXNATPathUpload</span></span>(<span>weasel, tree_view=True)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def selectXNATPathUpload(weasel, tree_view=True):
    listPaths = []
    if tree_view == True:
        images = weasel.images()
        for image in images:
            listPaths.append(image.path)
    else:
        directory = weasel.selectFolder(title=&#34;Select the directory with the files you wish to upload&#34;)
        for root, _, files in os.walk(directory):
            for filename in files:
                filepath = os.path.join(root, filename)
                listPaths.append(filepath)
    return listPaths</code></pre>
</details>
</dd>
<dt id="Weasel.Pipelines.XNAT__App.upload"><code class="name flex">
<span>def <span class="ident">upload</span></span>(<span>weasel)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def upload(weasel):
    try:
        url_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;URL&#34;, &#34;value&#34;:&#34;https://test-ukrin.dpuk.org&#34;}
        username_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;Username&#34;, &#34;value&#34;:&#34;your.xnat.username&#34;}
        password_input = {&#34;type&#34;:&#34;string&#34;, &#34;label&#34;:&#34;Password&#34;}
        cancel, loginDetails = weasel.user_input(url_input, username_input, password_input, title=&#34;XNAT Login&#34;)
        if cancel: return
        url = loginDetails[0][&#39;value&#39;] # https://test-ukrin.dpuk.org
        username = loginDetails[1][&#39;value&#39;]
        password = loginDetails[2][&#39;value&#39;]
        with xnat.connect(url, user=username, password=password) as session:
            xnatProjects = [project.secondary_id for project in session.projects.values()]
            projectWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Project&#34;, &#34;list&#34;:xnatProjects}
            cancel, project = weasel.user_input(projectWindow, title=&#34;XNAT Upload&#34;)
            if cancel: return
            projectID = project[0][&#39;list&#39;][project[0][&#39;value&#39;]]
            projectName = [project.name for project in session.projects.values() if project.secondary_id == projectID][0]
            if projectName:
                xnatSubjects = [subject.label for subject in session.projects[projectName].subjects.values()]
                xnatSubjects.insert(0, &#34;Upload at Project Level&#34;)
                subjectWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Subject&#34;, &#34;list&#34;:xnatSubjects}
                cancel, subject = weasel.user_input(subjectWindow, title=&#34;XNAT Upload&#34;)
                if cancel: return
                subjectName = subject[0][&#39;list&#39;][subject[0][&#39;value&#39;]]
                if subjectName:
                    if subjectName == &#34;Upload at Project Level&#34;:
                        uploadPaths = selectXNATPathUpload(weasel)
                        uploadZipFile = zipFiles(uploadPaths)
                        weasel.information(&#34;The selected images will be uploaded to the selected project. The upload progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Upload&#34;)
                        try:
                            weasel.message(&#34;Uploading files to XNAT...&#34;, &#34;XNAT Upload&#34;)
                            session.services.import_(uploadZipFile, overwrite=&#39;none&#39;, project=session.projects[projectName].id, content_type=&#39;application/zip&#39;)
                            weasel.close_message()
                        except:
                            warnings.warn(&#39;The zip file being uploaded contains files already present in the selected image session and the upload assistant cannot overwrite or give the option to not overwrite. \n The selected file or folder was pre-archived in the selected XNAT project. \n Please login to the portal and review and/or archive the images.&#39;)
                        weasel.information(&#34;Upload completed!&#34;, &#34;XNAT Upload&#34;)
                    else:
                        xnatExperiments = [experiment.label for experiment in session.projects[projectName].subjects[subjectName].experiments.values()]
                        xnatExperiments.insert(0, &#34;Upload at Subject Level&#34;)
                        experimentWindow = {&#34;type&#34;:&#34;dropdownlist&#34;, &#34;label&#34;:&#34;Experiment&#34;, &#34;list&#34;:xnatExperiments}
                        cancel, experiment = weasel.user_input(experimentWindow, title=&#34;XNAT Upload&#34;)
                        if cancel: return
                        experimentName = experiment[0][&#39;list&#39;][experiment[0][&#39;value&#39;]]
                        if experimentName:
                            if experimentName == &#34;Upload at Subject Level&#34;:
                                uploadPaths = selectXNATPathUpload(weasel)
                                uploadZipFile = zipFiles(uploadPaths)
                                weasel.information(&#34;The selected images will be uploaded to the selected subject. The upload progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Upload&#34;)
                                try:
                                    weasel.message(&#34;Uploading files to XNAT...&#34;, &#34;XNAT Upload&#34;)
                                    session.services.import_(uploadZipFile, overwrite=&#39;none&#39;, project=session.projects[projectName].id, subject=session.projects[projectName].subjects[subjectName].id, content_type=&#39;application/zip&#39;)
                                    weasel.close_message()
                                except:
                                    warnings.warn(&#39;The zip file being uploaded contains files already present in the selected image session and the upload assistant cannot overwrite or give the option to not overwrite. \n The selected file or folder was pre-archived in the selected XNAT project. \n Please login to the portal and review and/or archive the images.&#39;)
                                weasel.information(&#34;Upload completed!&#34;, &#34;XNAT Upload&#34;)
                            else:
                                uploadPaths = selectXNATPathUpload(weasel)
                                uploadZipFile = zipFiles(uploadPaths)
                                weasel.information(&#34;The selected images will be uploaded to the selected experiment. The upload progress can be checked in the terminal and you may continue using Weasel.&#34;, &#34;XNAT Upload&#34;)
                                try:
                                    weasel.message(&#34;Uploading files to XNAT...&#34;, &#34;XNAT Upload&#34;)
                                    session.services.import_(uploadZipFile, overwrite=&#39;none&#39;, project=session.projects[projectName].id, subject=session.projects[projectName].subjects[subjectName].id, experiment=session.projects[projectName].subjects[subjectName].experiments[experimentName].id, content_type=&#39;application/zip&#39;)
                                    weasel.close_message()
                                except:
                                    warnings.warn(&#39;The zip file being uploaded contains files already present in the selected image session and the upload assistant cannot overwrite or give the option to not overwrite. \n The selected file or folder was pre-archived in the selected XNAT project. \n Please login to the portal and review and/or archive the images.&#39;)
                                weasel.information(&#34;Upload completed!&#34;, &#34;XNAT Upload&#34;)
        # Curl Command
        headers = {&#34;Content-Type&#34;: &#34;application/json&#34;, &#34;Accept&#34;: &#34;*/*&#34;}
        # Update the project&#39;s indices
        for individual_experiment in session.projects[projectName].experiments:
            curl_url = url + &#34;/xapi/viewer/projects/&#34; + session.projects[projectName].id + &#34;/experiments/&#34; + individual_experiment
            response = requests.post(curl_url, headers=headers, auth=(username, password))
        # Delete Login Details
        del loginDetails, url, username, password
        # Delete ZIP File
        os.remove(uploadZipFile)
        session.disconnect()
    except Exception as e:
        weasel.log_error(&#39;Error in function XNATapp.upload: &#39; + str(e))
        if &#34;Could not determine if login was successful!&#34; in str(e):
            weasel.information(&#34;The login details inserted are incorrect!&#34;, &#34;XNAT Download&#34;) </code></pre>
</details>
</dd>
<dt id="Weasel.Pipelines.XNAT__App.zipFiles"><code class="name flex">
<span>def <span class="ident">zipFiles</span></span>(<span>listPaths)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def zipFiles(listPaths):
    dt = datetime.datetime.now()
    zip_file = zipfile.ZipFile(dt.strftime(&#39;%Y%m%d&#39;) + &#39;_xnat_upload.zip&#39;, &#39;w&#39;)
    for file in listPaths:
        zip_file.write(file, compress_type=zipfile.ZIP_DEFLATED)
    zip_file.close()
    zip_path = os.path.realpath(zip_file.filename)
    return zip_path</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="Weasel.Pipelines" href="index.html">Weasel.Pipelines</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="Weasel.Pipelines.XNAT__App.download" href="#Weasel.Pipelines.XNAT__App.download">download</a></code></li>
<li><code><a title="Weasel.Pipelines.XNAT__App.isEnabled" href="#Weasel.Pipelines.XNAT__App.isEnabled">isEnabled</a></code></li>
<li><code><a title="Weasel.Pipelines.XNAT__App.selectXNATPathDownload" href="#Weasel.Pipelines.XNAT__App.selectXNATPathDownload">selectXNATPathDownload</a></code></li>
<li><code><a title="Weasel.Pipelines.XNAT__App.selectXNATPathUpload" href="#Weasel.Pipelines.XNAT__App.selectXNATPathUpload">selectXNATPathUpload</a></code></li>
<li><code><a title="Weasel.Pipelines.XNAT__App.upload" href="#Weasel.Pipelines.XNAT__App.upload">upload</a></code></li>
<li><code><a title="Weasel.Pipelines.XNAT__App.zipFiles" href="#Weasel.Pipelines.XNAT__App.zipFiles">zipFiles</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>